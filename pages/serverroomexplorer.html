<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Server Room Explorer</title>

  <!-- Base styling -->
  <link rel="stylesheet" href="../styles/base.css">

  <!-- Explorer specific styling -->
  <link rel="stylesheet" href="../styles/serverroomexplorer.css">

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

<script type="module">

import { loadLayout } from "/rack-power-calculator/app/layout.js";
import { servers as SERVER_PROFILES } from "/rack-power-calculator/data/servers.js";
import { calculateRack } from "/rack-power-calculator/core/eatoncalculator.js";
import { DRIVE_CATALOG } from "/rack-power-calculator/data/drives.js";
import { analyzeRack, calculateRackPenalty } from "/rack-power-calculator/core/rackAnalysis.js";
import { suggestBestPlacement } from "/rack-power-calculator/core/placementAdvisor.js";
import { suggestBestSlot } from "/rack-power-calculator/core/slotAdvisor.js";
import { RACK_CLASSIFICATION } 
from "/rack-power-calculator/data/rack_classification.js";

let selectedRackId = null;
let currentRackServers = [];
let rackServers = [];

window.addEventListener("DOMContentLoaded", async () => {
  await loadLayout("serverroom");

  document.getElementById("content").innerHTML = `

<!-- =========================
     DATA & SEARCH
========================= -->
<div class="control-group">
  <div class="control-title">Data & Search</div>
  <div class="control-row">
    <button id="clearMemory">Clear Saved CSV</button>
    <input type="file" id="csvInput" accept=".csv">
    
    <input
      type="text"
      id="searchInput"
      placeholder="Search hostname / account"
    >

  </div>
</div>

<!-- =========================
     HARDWARE FILTERS
========================= -->
<div class="control-group">
  <div class="control-title">Hardware Filters</div>
  <div class="control-row">

    <select id="filterBoard">
      <option value="">Motherboard</option>
    </select>

    <select id="filterHeight">
      <option value="">Height</option>
    </select>

    <select id="filterCpu">
      <option value="">CPU</option>
    </select>

    <select id="filterRam">
      <option value="">RAM</option>
    </select>

    <select id="filterController">
      <option value="">Controller</option>
    </select>

    <select id="filterDriveGeneric">
      <option value="">Drive Type</option>
    </select>

    <select id="filterDrives">
      <option value="">Drive Model</option>
    </select>

    <button id="clearFilters">Reset</button>

  </div>
</div>


<!-- =========================
     SERVER PLACEMENT ADVISOR
========================= -->
<div class="placement-wrapper">

  <!-- LEFT: CONTROLS -->
  <div class="placement-controls">
    <div class="placement-title">
      Server Placement Advisor
    </div>

    <div class="placement-fields">
      <select id="placementServerSelect">
        <option value="">Select Server</option>
      </select>

      <select id="placementRoomSelect">
        <option value="">Select Room</option>
      </select>

      <div class="placement-exclude">

  <div class="exclude-title">Exclude Rack Types</div>

  <label><input type="checkbox" value="NO_PROV" checked> No Provision</label>
  <label><input type="checkbox" value="STORAGE" checked> Storage</label>
  <label><input type="checkbox" value="COD" checked> COD</label>
  <label><input type="checkbox" value="INTERNAL" checked> Internal</label>
  <label><input type="checkbox" value="G25" checked> 25G</label>

</div>

<button id="placementSearchBtn">
  Search Best Location
</button>

<button id="placementResetBtn" class="placement-reset-btn">
  Reset
</button>
    </div>
  </div>

  <!-- RIGHT: RESULTS -->
  <div class="placement-results">
    <div class="placement-results-title">
      Results
    </div>

    <div id="placementAdvisor"></div>
  </div>

</div>


<div class="rooms" id="rooms"></div>

<div id="statusOverview" class="status-overview"></div>

<div id="rackContainer"></div>

<div class="main-split">
  <div id="rackDetail" class="left-pane"></div>
  <div class="right-pane">
    <div id="powerSummary"></div>
  </div>
</div>

<div id="pduLaunchContainer"></div>
<button id="backToTop" class="back-to-top">â†‘</button>
  `;

  init();
});


/* ========================= */

const MAX_SLOTS = 44;
const BANK_LIMIT = 8;
const PHASE_LIMIT = 16;
let activeStatusFilters = new Set();
const STATUS_SHORT = {
  ACTIVE: "A",
  RESERVED: "R",
  PLANNED: "P",
  INVENTORY: "I",
  LIQUIDATION: "L",
  QUARANTINE: "Q",
  MISSING_PARTS: "MP",
  HARDFAIL: "H",
  RECLAIM: "R",
  DEPLOY: "D",
  SPARE: "S",
  LIQUIDATE_PREP: "LP",
  LIQUIDATION_PROCESSING: "LPR",
  SPARE_POOL: "SP",
  DEPLOY2: "D2"
};



/* ========================= HELPERS ========================= */

function showPduButton() {

  const container = document.getElementById("pduLaunchContainer");
  if (!container || !selectedRackId) return;

 container.innerHTML = `
  <div class="pdu-launch-wrapper">
    <button class="pdu-btn eaton" data-type="eaton">
     View in Eaton
    </button>
    <button class="pdu-btn servertech" data-type="servertech">
     View in ServerTech
    </button>
    <button class="pdu-btn apc" data-type="apc">
     View in APC
    </button>
  </div>
`;

  container.querySelectorAll(".pdu-btn").forEach(btn => {
btn.onclick = () => {

  const type = btn.dataset.type;

  const rackData = rackServers.filter(
    s => s.rack === selectedRackId
  );

sessionStorage.setItem(`${type}_selected_rack`, selectedRackId);
sessionStorage.setItem(`${type}_selected_rack_data`,JSON.stringify(currentRackServers));

      // doorsturen
window.location.href =
  `${type}.html?rack=${selectedRackId}`;
    };
  });
}



 /**********************************************************************************************/

function extractSlotNumber(value) {
  const match = value?.match(/\d+/);
  return match ? parseInt(match[0], 10) : 0;
}

 /**********************************************************************************************/

function statusClass(status) {
  return status ? "status-" + status.toUpperCase() : "";
}

 /**********************************************************************************************/

function cleanBoardName(full) {
  if (!full) return "";

  // Lenovo SR modellen inclusief -V2/-V3 etc
  const lenovoMatch = full.match(/SR\d{3}(?:-[A-Z0-9]+)?/i);
  if (lenovoMatch) return lenovoMatch[0];

  // Supermicro X-serie
  const smMatch = full.match(/(X\d{2}[A-Z0-9\-\+]+)/i);
  if (smMatch) return smMatch[0];

  return full.split(" ")[1] ?? full;
}
 /**********************************************************************************************/

function findServerProfile(boardName) {
  if (!boardName) return null;

  const lower = boardName.toLowerCase();

  return SERVER_PROFILES.find(s =>
    lower.includes(s.baseId?.toLowerCase()) ||
    lower.includes(s.id?.toLowerCase()) ||
    lower.includes(s.name?.toLowerCase())
  );
}

 /**********************************************************************************************/

function buildHardwareTooltip(server) {

  const profile = findServerProfile(server.motherboard);

  const height = profile?.uHeight
    ? `${profile.uHeight}U`
    : server.unitSizeCsv
      ? `${server.unitSizeCsv}U`
      : "Unknown";

const ramInfo = calculateRamConfig(server.ram);

return `
  <div class="hw-wrapper">
    <strong>Motherboard</strong><div>${server.motherboard || "-"}</div>
    <strong>CPU</strong><div>${server.cpu || "-"}</div>

    <strong>RAM</strong><div>${ramInfo.model}</div>
    <strong>RAM Config</strong><div>${ramInfo.detail}</div>

    <strong>Controller</strong><div>${server.controller || "-"}</div>
    <strong>Drives</strong><div>${server.drives || "-"}</div>
    <strong>Height</strong><div>${height}</div>
  </div>
`;
}

 /**********************************************************************************************/


function calculateRamConfig(ramString) {

  if (!ramString) {
    return {
      total: "-",
      detail: "-",
      model: "-"
    };
  }

  // Zoek grootte per dimm (bijv 8GB, 16GB, 32GB)
  const sizeMatch = ramString.match(/(\d+)\s?GB/i);

  // Zoek aantal dimms (vaak achteraan: - 2)
  const countMatch = ramString.match(/-\s?(\d+)$/);

  if (!sizeMatch || !countMatch) {
    return {
      total: "-",
      detail: "-",
      model: ramString
    };
  }

  const dimmSize = parseInt(sizeMatch[1], 10);
  const dimmCount = parseInt(countMatch[1], 10);

  const total = dimmSize * dimmCount;

  return {
    total: `${total}GB`,
    detail: `${dimmCount} Ã— ${dimmSize}GB = ${total}GB`,
    model: ramString
  };
}

 /**********************************************************************************************/

function formatHardwareAge(days) {

  if (!days || days <= 0) return "-";

  const years = Math.floor(days / 365);
  const remainingDays = days % 365;
  const months = Math.floor(remainingDays / 30);

  if (years === 0 && months === 0) {
    return `${days}d`;
  }

  if (years === 0) {
    return `${months}m`;
  }

  if (months === 0) {
    return `${years}y`;
  }

  return `${years}y ${months}m`;
}

 /**********************************************************************************************/

function normalizeHardwareString(value) {
  if (!value) return "";

  return value
    .replace(/\s*-\s*\d+$/, "")   // verwijder " - 16" ongeacht spaties
    .trim();
}

 /**********************************************************************************************/

function extractHardwareModels(value) {
  if (!value) return [];

  return value
    .split(/\s-\s/) // splits configuratie op " - "
    .map(part => part.trim())

    // verwijder entries die alleen aantallen zijn
    .filter(part => !/^\d+$/.test(part))

    // verwijder leading aantallen zoals "1 Intel..."
    .map(part => part.replace(/^\d+\s+/, ""))

    // verwijder (Installed) of Installed
    .map(part => part.replace(/\(Installed\)/gi, "")
                    .replace(/\bInstalled\b/gi, "")
                    .trim())

    // verwijder alles waar Disabled in voorkomt
    .filter(part => !/disabled/i.test(part))

    .filter(Boolean);
}

 /**********************************************************************************************/

function resolveDriveEntries(driveString) {
  if (!driveString) return [];

  const models = extractHardwareModels(driveString);
  const results = [];

  models.forEach(modelString => {

    DRIVE_CATALOG.forEach(entry => {
      entry.models.forEach(model => {
        if (modelString.includes(model)) {
          results.push(entry);
        }
      });
    });

  });

  return results;
}

 /**********************************************************************************************/

function buildDriveLabel(entry) {
  return `${entry.media} ${entry.capacityGB}GB`;
}

 /**********************************************************************************************/

function isOlderThanSixYears(days) {
  if (!days) return false;
  return days >= (6 * 365);
}

 /**********************************************************************************************/

function formatRackName(rack) {
  if (!rack) return "Unknown";

  const match = rack.match(/\d+/);
  if (!match) return rack;

  return `Rack ${match[0]}`;
}


 /**********************************************************************************************/

function buildAllRacks(filteredServers) {

  const racks = {};

  // 1ï¸âƒ£ Groepeer servers per rack
  filteredServers.forEach(s => {
    if (!s.rack || !s.slot) return;

    if (!racks[s.rack]) {
      racks[s.rack] = [];
    }

    racks[s.rack].push(s);
  });

  const result = [];

  // 2ï¸âƒ£ Bouw rack-structuur
  Object.entries(racks).forEach(([rackId, servers]) => {

    // Maak rackInput voor power-berekening
    const rackInput = servers.map(s => {
      const profile = findServerProfile(s.motherboard);

      return {
        slot: s.slot,
        serverProfile: profile,
        utilization: "normal"
      };
    });

    const powerResult = calculateRack(rackInput);

    // Bouw servers-structuur voor placement engine
    const structuredServers = servers.map(s => {
      const profile = findServerProfile(s.motherboard);

      return {
        slot: s.slot,
        uHeight: profile?.uHeight || 1,
        serverProfile: profile
      };
    });

result.push({
  rackId,
  dc: servers[0].dc,          // ðŸ”¥ toevoegen
  room: servers[0].room,
  servers: structuredServers,
  banks: powerResult.banks,
  phases: powerResult.phases
});
  });

  return result;
}

/**********************************************************************************************/

function buildPlacementExplanation(s) {

  const reasons = [];

  const load = Math.round(s.slotScore * 100);

  if (load < 50) {
    reasons.push("Very low impact on rack power");
  } else if (load < 70) {
    reasons.push("Acceptable power impact");
  } else {
    reasons.push("Higher load impact â€“ monitor closely");
  }

  if (s.phaseBalanceScore < 0.2) {
    reasons.push("Keeps power evenly balanced");
  }

  if (s.bankUtilization < 0.6) {
    reasons.push("Plenty of power capacity remaining");
  }

  if (reasons.length === 0) {
    reasons.push("Within safe operating limits");
  }

  return reasons.map(r => `â€¢ ${r}`).join("<br>");
}

 /**********************************************************************************************/

function formatRackDisplay(rackId) {

  if (!rackId) return "Unknown Rack";

  // ðŸ”¹ Zoek een server die bij dit rack hoort
  const server = currentRackServers?.find(s => s.rack === rackId);

  if (!server) {
    // fallback als geen context beschikbaar
    const num = rackId.match(/\d+/)?.[0];
    return num ? `Rack ${num}` : rackId;
  }

  const roomNumber = server.room?.replace(/\D/g, "") || "";
  const rackNumber = rackId.match(/\d+/)?.[0] || rackId;

  return `Server Room ${roomNumber} - Rack ${rackNumber}`;
}

/**********************************************************************************************/

function smoothScrollToDetail() {

  const split = document.querySelector(".main-split");
  if (!split) return;

  split.scrollIntoView({
    behavior: "smooth",
    block: "start"
  });
}
/**********************************************************************************************/

function getRackClassification(dc, room, rack) {

  if (!dc || !room || !rack) return null;

  const key = `${dc}.${room}`;   // DC03.SR01

  const dcConfig = RACK_CLASSIFICATION[key];
  if (!dcConfig) return null;

  for (const [type, rackList] of Object.entries(dcConfig)) {
    if (rackList.includes(rack)) {
      return type;
    }
  }

  return null;
}

/* ========================= MAIN ========================= */

function init() {

const savedData = localStorage.getItem("serverroom_data");

if (savedData) {
  rackServers = JSON.parse(savedData);
  populateFilters(rackServers);
  renderRooms();
  populatePlacementRooms(rackServers);
}



  

  
  populatePlacementServers();

  /* ================= FILTER LISTENERS ================= */

const serverSelect = document.getElementById("placementServerSelect");
const roomSelect   = document.getElementById("placementRoomSelect");
const searchBtn    = document.getElementById("placementSearchBtn");
const resetBtn     = document.getElementById("placementResetBtn");

function updatePlacementButton() {
  searchBtn.disabled = !serverSelect.value || !roomSelect.value;
}

serverSelect.addEventListener("change", () => {
  serverSelect.classList.remove("field-error");
  updatePlacementButton();
});

roomSelect.addEventListener("change", () => {
  roomSelect.classList.remove("field-error");
  updatePlacementButton();
});


searchBtn.addEventListener("click", () => {

  if (!serverSelect.value) {
    serverSelect.classList.add("field-error");
    return;
  }

  if (!roomSelect.value) {
    roomSelect.classList.add("field-error");
    return;
  }

  const profile = SERVER_PROFILES.find(
    s => s.id === serverSelect.value
  );

  if (!profile) return;

  const normalizedRoom = roomSelect.value.trim().toUpperCase();

  const baseData = rackServers.filter(s =>
    s.room?.trim().toUpperCase() === normalizedRoom
  );

  const allRacks = buildAllRacks(baseData);

  const excludedTypes = Array.from(
    document.querySelectorAll(".placement-exclude input[type='checkbox']")
  )
  .filter(cb => cb.checked)   
  .map(cb => cb.value);

  const filteredRacks = allRacks.filter(r => {

    const rackType = getRackClassification(
      r.dc,
      r.room,
      r.rackId
    );

    if (!rackType) return true;

    return !excludedTypes.includes(rackType);
  });

  const suggestions = suggestBestPlacement(
    profile,
    filteredRacks,
    suggestBestSlot
  );

  renderPlacementAdvisor(suggestions);
});

resetBtn.addEventListener("click", () => {
  serverSelect.value = "";
  roomSelect.value = "";
  document.getElementById("placementAdvisor").innerHTML = "";
  updatePlacementButton();
});

updatePlacementButton();

  document.querySelectorAll("#content select")
    .forEach(select => select.addEventListener("change", renderRooms));

document.getElementById("clearFilters")
  .addEventListener("click", () => {
    document.querySelectorAll("#content select")
      .forEach(s => s.value = "");
    renderRooms();
  });

document.getElementById("csvInput").addEventListener("change", e => {
  const reader = new FileReader();

  reader.onload = evt => {

    const rawCsv = evt.target.result;

    rackServers = parseCSV(rawCsv);

    localStorage.setItem(
      "serverroom_data",
      JSON.stringify(rackServers)
    );

    populateFilters(rackServers);
    renderRooms();
    populatePlacementRooms(rackServers);
  };

  reader.readAsText(e.target.files[0]);
});
  document.getElementById("searchInput")
    .addEventListener("input", renderRooms);

    document.getElementById("clearMemory")
  ?.addEventListener("click", () => {
if (!confirm("Clear stored rack data?")) return;

    localStorage.removeItem("serverroom_data");

    rackServers = [];

    document.getElementById("rackContainer").innerHTML = "";
    document.getElementById("rackDetail").innerHTML = "";
    document.getElementById("powerSummary").innerHTML = "";
    document.getElementById("placementAdvisor").innerHTML = "";

    location.reload(); // simpel en schoon
});


renderPlacementAdvisor();

 /**********************************************************************************************/

function populateFilters(data) {

  const filterMap = {
    filterBoard: [...new Set(data.map(s => s.motherboard).filter(Boolean))],

    filterCpu: [...new Set(
      data.map(s => normalizeHardwareString(s.cpu)).filter(Boolean)
    )],

    filterRam: [...new Set(
      data.map(s => normalizeHardwareString(s.ram)).filter(Boolean)
    )],

    filterController: [...new Set(
      data.flatMap(s => extractHardwareModels(s.controller))
    )],

filterDriveGeneric: [...new Set(
  data.flatMap(s =>
    resolveDriveEntries(s.drives)
      .map(e => buildDriveLabel(e))
  )
)].sort((a,b) => a.localeCompare(b)),

    filterDrives: [...new Set(
      data.flatMap(s => extractHardwareModels(s.drives))
    )]
  };

  const heights = [...new Set(
    data.map(s => {
      const profile = findServerProfile(s.motherboard);
      return profile?.uHeight ? `${profile.uHeight}U` : null;
    }).filter(Boolean)
  )];

  filterMap.filterHeight = heights;

  Object.entries(filterMap).forEach(([id, values]) => {

    const select = document.getElementById(id);
    if (!select) return;

    const currentValue = select.value;
    const defaultLabel = select.options[0]?.textContent || "";

    select.innerHTML = `<option value="">${defaultLabel}</option>`;

    // ðŸ”¥ Generic drives (object-based)
if (id === "filterDriveGeneric") {

  values.forEach(label => {
    const opt = document.createElement("option");
    opt.value = label;
    opt.textContent = label;
    select.appendChild(opt);
  });

} else {

      values
        .sort((a, b) => a.localeCompare(b))
        .forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          select.appendChild(opt);
        });
    }

    // restore previous selection if still valid
    if ([...select.options].some(o => o.value === currentValue)) {
      select.value = currentValue;
    }

  });
}

 /**********************************************************************************************/

  function parseCSV(text) {

    const result = Papa.parse(text, {
      header: true,
      skipEmptyLines: true
    });

    return result.data
      .filter(r => r["View Hardware"]?.includes("HYPERLINK"))
      .map(row => {

        // ðŸ”¹ Extract volledige hyperlink uit HYPERLINK(...)
        const linkMatch = row["View Hardware"]?.match(/"(https:[^"]+)"/i);
        let hardwareUrl = linkMatch ? linkMatch[1] : null;

        // ðŸ”¹ view â†’ update vervangen
        if (hardwareUrl) {
          hardwareUrl = hardwareUrl.replace("/view/", "/update/");
        }

        const loc = (row["Location"] || "").split(".");

return {
  hostname: row["Fully Qualified Domain Name"] || "",
  status: row["Hardware Status"] || "",
  sltag: row["SoftLayer Serial Number"] || "",
  accountId: row["Account Id"] || "",
  ageDays: parseInt(row["Days old"], 10) || 0,
  hardwareUrl: hardwareUrl,

  motherboard: cleanBoardName(row["Motherboard Model"]),
  cpu: row["Processor Model (Expand Row to view additional models)"] || "",
  ram: row["Ram Model (Expand Row to view additional models)"] || "",
  drives: row["Hard Drive Model (Expand Row to view additional models)"] || "",
  controller: row["Drive Controller Model (Expand Row to view additional models)"] || "",
  driveCapacity: row["Drive Capacity"] || "",
  psu: row["Power Capacity"] || "",
  unitSizeCsv: row["Unit Size"] || "",

  dc: (loc[0] || "").toUpperCase(),
  room: (loc[1] || "").toUpperCase(),
  rack: (loc[2] || "").toUpperCase(),
  slot: (row["Slot"] || "").toString().trim().toUpperCase(),
};
      });
  }

  /**********************************************************************************************/


function renderRooms() {

  const search = document.getElementById("searchInput").value.toLowerCase();

  const filters = {
    board: document.getElementById("filterBoard").value,
    height: document.getElementById("filterHeight").value,
    cpu: document.getElementById("filterCpu").value,
    ram: document.getElementById("filterRam").value,
    controller: document.getElementById("filterController").value,
    driveGeneric: document.getElementById("filterDriveGeneric").value,
    drives: document.getElementById("filterDrives").value
  };

  const filtered = rackServers.filter(s => {

    const profile = findServerProfile(s.motherboard);
    const height = profile?.uHeight ? `${profile.uHeight}U` : "";

    return (
      (!search ||
        s.hostname.toLowerCase().includes(search) ||
        s.accountId.toLowerCase().includes(search)
      ) &&
      (!filters.board || s.motherboard === filters.board) &&
      (!filters.cpu || normalizeHardwareString(s.cpu) === filters.cpu) &&
      (!filters.ram || normalizeHardwareString(s.ram) === filters.ram) &&
      (!filters.controller || extractHardwareModels(s.controller).includes(filters.controller)) &&
      (!filters.driveGeneric || resolveDriveEntries(s.drives).map(e => buildDriveLabel(e)).includes(filters.driveGeneric)) &&
      (!filters.drives || extractHardwareModels(s.drives).includes(filters.drives)) &&
      (!filters.height || height === filters.height) &&
      (
        activeStatusFilters.size === 0 ||
        activeStatusFilters.has(
          (s.status || "").toUpperCase().replace(/\s+/g, "_")
        )
      )
    );
  });

  populateFilters(filtered.length ? filtered : rackServers);

  const rooms = [...new Set(
    filtered
      .map(s => s.room)
      .filter(r => r && !r.startsWith("STR"))
  )].sort((a, b) => a.localeCompare(b));

  const container = document.getElementById("rooms");
  container.innerHTML = "";

  const allBtn = document.createElement("div");
  allBtn.className = "room-btn";
  allBtn.textContent = "ALL";

  allBtn.onclick = () => {
    document.querySelectorAll(".room-btn")
      .forEach(b => b.classList.remove("active"));

    allBtn.classList.add("active");
    renderAllRooms(filtered);
    renderStatusOverview(rackServers);
  };

  container.appendChild(allBtn);

  rooms.forEach(room => {

    const btn = document.createElement("div");
    btn.className = "room-btn";
    btn.textContent = room;

    btn.onclick = () => {
      document.querySelectorAll(".room-btn")
        .forEach(b => b.classList.remove("active"));

      btn.classList.add("active");

      renderRacks(filtered, room);
      renderStatusOverview(rackServers);
    };

    container.appendChild(btn);
  });

  allBtn.click();
}

 /**********************************************************************************************/

function createRackCard({ title, rack, list }) {

  const stats = {};

  list.forEach(s => {
    const status = (s.status || "")
      .toUpperCase()
      .trim()
      .replace(/\s+/g, "_");

    if (!status) return;

    stats[status] = (stats[status] || 0) + 1;
  });

  const card = document.createElement("div");
  card.className = "rack-card";
  card.dataset.rack = rack;
  card.dataset.room = list[0]?.room || "";
  card.dataset.dc   = list[0]?.dc   || "";

  // ðŸ”¥ EERST declareren
  const classification = getRackClassification(
    list[0]?.dc,
    list[0]?.room,
    rack
  );

  // ðŸ”¥ DAN pas gebruiken
  if (classification) {
    card.classList.add(`type-${classification}`);
  }

  card.innerHTML = `
    ${classification ? `
      <div class="rack-type-pill type-${classification}">
        ${classification.replace(/_/g, " ")}
      </div>
    ` : ""}

    <div class="rack-title">${title}</div>
    <div>${list.length} / ${MAX_SLOTS} used</div>

    <div class="rack-stats">
      ${
        Object.entries(stats)
          .filter(([_, count]) => count > 0)
          .map(([status, count]) => `
            <div class="rack-pill status-${status}">
              ${STATUS_SHORT[status] || status}-${count}
              <span class="pill-tooltip">
                ${status.replace(/_/g, " ")}: ${count}
              </span>
            </div>
          `)
          .join("")
      }
    </div>
  `;

  card.onclick = () => {
    selectedRackId = rack;
    currentRackServers = list;

    renderRackDetail(rack, list);
    renderPowerSummary(rack, list);
    showPduButton();
    smoothScrollToDetail();
  };

  return card;
}

 /**********************************************************************************************/

function renderAllRooms(data) {

  const container = document.getElementById("rackContainer");
  container.innerHTML = `<div class="rack-grid"></div>`;
  const grid = container.firstChild;

  const rooms = [...new Set(
    data
      .map(s => s.room)
      .filter(r => r && !r.startsWith("STR"))
  )].sort((a, b) => a.localeCompare(b));

  rooms.forEach(room => {

    const racks = {};

    data
      .filter(s => s.room === room)
      .forEach(s => {

        // ðŸ”´ Geen rack â†’ room unassigned bucket
        if (!s.rack || String(s.rack).trim() === "") {

          if (!racks["__ROOM_UNASSIGNED__"]) {
            racks["__ROOM_UNASSIGNED__"] = [];
          }

          racks["__ROOM_UNASSIGNED__"].push(s);
          return;
        }

        // ðŸŸ¢ Normale rack
        if (!racks[s.rack]) {
          racks[s.rack] = [];
        }

        racks[s.rack].push(s);
      });

    Object.keys(racks)
      .sort((a, b) => {

        if (a === "__ROOM_UNASSIGNED__") return -1;
        if (b === "__ROOM_UNASSIGNED__") return 1;

        return parseInt(a.replace("RK", "")) - parseInt(b.replace("RK", ""));
      })
      .forEach(rack => {

        const list = racks[rack];

        // ðŸ”´ Speciale kaart
        if (rack === "__ROOM_UNASSIGNED__") {

          const roomNumber = room.replace(/\D/g,"");

          const card = document.createElement("div");
          card.className = "rack-card special-room-card";

          card.innerHTML = `
            <div class="rack-title">
              Server Room ${roomNumber} - Unassigned
            </div>
            <div>${list.length} devices</div>
          `;

          card.onclick = () => {
            renderRoomUnassigned(list);
            smoothScrollToDetail();
          };

          grid.appendChild(card);
          return;
        }

        // ðŸŸ¢ Normale rack
        const card = createRackCard({
          title: `${room} - ${formatRackName(rack)}`,
          rack,
          list
        });

        grid.appendChild(card);
      });
  });
}


 /**********************************************************************************************/

 function renderRoomUnassigned(list) {

  const container = document.getElementById("rackDetail");

  container.innerHTML = `
    <div class="rack-detail-header">
      Room Devices Without Rack
    </div>

    <div class="slot-row header">
      <div>Status</div>
      <div>Function</div>
      <div>Hostname</div>
      <div>Serial</div>
      <div>Account</div>
    </div>
  `;

  list.forEach(device => {

    const row = document.createElement("div");
    row.className = "slot-row";

    row.innerHTML = `
      <div>
        <span class="status-badge ${statusClass(device.status)}">
          ${device.status || "-"}
        </span>
      </div>

      <div>${device.hardwareFunction || "-"}</div>
      <div>${device.hostname || "-"}</div>
      <div>${device.sltag || "-"}</div>
      <div>${device.accountId || "-"}</div>
    `;

    container.appendChild(row);
  });

  document.getElementById("powerSummary").innerHTML = "";
}


 /**********************************************************************************************/


function renderRacks(data, room) {

Object.keys(racks)
  .sort((a, b) => {

    if (a === "__ROOM_UNASSIGNED__") return -1;
    if (b === "__ROOM_UNASSIGNED__") return 1;

    return parseInt(a.replace("RK", "")) - parseInt(b.replace("RK", ""));
  })
  .forEach(rack => {

    const list = racks[rack];

    // ðŸ”´ Speciale room bucket
    if (rack === "__ROOM_UNASSIGNED__") {

      const roomNumber = room.replace(/\D/g,"");

      const card = document.createElement("div");
      card.className = "rack-card special-room-card";

      card.innerHTML = `
        <div class="rack-title">
          Server Room ${roomNumber} - Unassigned
        </div>
        <div>${list.length} devices</div>
      `;

      card.onclick = () => {
        renderRoomUnassigned(list);
        smoothScrollToDetail();
      };

      container.appendChild(card);
      return;
    }

    // ðŸŸ¢ Normale rack
    const card = createRackCard({
      title: formatRackName(rack),
      rack,
      list
    });

    container.appendChild(card);
});

  const grid = document.getElementById("rackContainer");
  grid.innerHTML = `<div class="rack-grid"></div>`;
  const container = grid.firstChild;

  if (unassigned.length > 0) {

  const card = document.createElement("div");
  card.className = "rack-card";

  const stats = {};

  unassigned.forEach(s => {
    const status = (s.status || "")
      .toUpperCase()
      .trim()
      .replace(/\s+/g, "_");

    if (!status) return;

    stats[status] = (stats[status] || 0) + 1;
  });

  card.innerHTML = `
    <div class="rack-title">UNASSIGNED</div>
    <div>${unassigned.length} items</div>

    <div class="rack-stats">
      ${
        Object.entries(stats)
          .map(([status, count]) => `
            <div class="rack-pill status-${status}">
              ${STATUS_SHORT[status] || status}-${count}
              <span class="pill-tooltip">
                ${status.replace(/_/g, " ")}: ${count}
              </span>
            </div>
          `)
          .join("")
      }
    </div>
  `;

card.onclick = () => {
  renderUnassignedDetail(unassigned);
  smoothScrollToDetail();
};


  container.appendChild(card);
}

Object.keys(racks)
  .sort((a, b) => {

    if (a === "__ROOM_UNASSIGNED__") return -1;
    if (b === "__ROOM_UNASSIGNED__") return 1;

    return parseInt(a.replace("RK", "")) - parseInt(b.replace("RK", ""));
  })
  .forEach(rack => {

    const list = racks[rack];

    // ðŸ”´ Speciale room bucket
    if (rack === "__ROOM_UNASSIGNED__") {

      const roomNumber = room.replace(/\D/g,"");

      const card = document.createElement("div");
      card.className = "rack-card special-room-card";

      card.innerHTML = `
        <div class="rack-title">
          Server Room ${roomNumber} - Unassigned
        </div>
        <div>${list.length} devices</div>
      `;

      card.onclick = () => {
        renderRoomUnassigned(list);
        smoothScrollToDetail();
      };

      container.appendChild(card);
      return;
    }

    // ðŸŸ¢ Normale rack
    const card = createRackCard({
      title: formatRackName(rack),
      rack,
      list
    });

    container.appendChild(card);
});
}

 /**********************************************************************************************/

function renderUnassignedDetail(list) {

  const container = document.getElementById("rackDetail");

  container.innerHTML = `
    <div class="rack-detail-header">UNASSIGNED</div>

    <div class="unassigned-row unassigned-header">
      <div>Status</div>
      <div>Board</div>
      <div>Hostname</div>
      <div>SLTag</div>
      <div>Account</div>
      <div>Age</div>
    </div>
  `;

  list.forEach(server => {

    const row = document.createElement("div");
    row.className = "unassigned-row";

    row.innerHTML = `
      <div>
        <span class="status-badge ${statusClass(server.status)}">
          ${server.status || "-"}
        </span>
      </div>

      <div class="board-cell">
        <span class="hardware-icon">
          <svg class="hw-icon" viewBox="0 0 24 24">
            <rect x="3" y="5" width="18" height="4" rx="1"></rect>
            <rect x="3" y="11" width="18" height="4" rx="1"></rect>
            <rect x="3" y="17" width="18" height="2" rx="1"></rect>
          </svg>
          <div class="hardware-tooltip">
            ${buildHardwareTooltip(server)}
          </div>
        </span>
        <span class="board-name">
          ${server.motherboard || "-"}
        </span>
      </div>

      <div class="hostname">${server.hostname || "-"}</div>

      <div>
        ${
          server.hardwareUrl
            ? `<a href="${server.hardwareUrl}"
                 target="_blank"
                 class="rack-link">
                 ${server.sltag || "-"}
               </a>`
            : (server.sltag || "-")
        }
      </div>

      <div>${server.accountId || "-"}</div>

      <div class="age-cell">
        ${formatHardwareAge(server.ageDays)}
        ${
          isOlderThanSixYears(server.ageDays)
            ? `
              <span class="age-warning-wrapper">
                <span class="age-warning">!</span>
                <span class="age-tooltip">
                  Server age exceeds 6 years
                </span>
              </span>
            `
            : ""
        }
      </div>
    `;

    container.appendChild(row);
  });
}


 /**********************************************************************************************/

function renderRackDetail(rack, list) {

  const container = document.getElementById("rackDetail");

  container.innerHTML = `
    <div class="rack-detail-header">
      <div class="rack-header-left">
        ${formatRackDisplay(rack)}
      </div>
      <div class="rack-header-right" id="pduLaunchContainer"></div>
    </div>

    <div class="slot-row header">
      <div>#</div>
      <div>Status</div>
      <div>Board</div>
      <div>Hostname</div>
      <div>SLTag</div>
      <div>Account</div>
      <div>Age</div>
    </div>
  `;

  // ðŸ”¥ Maak slotMap case-consistent
  const slotMap = {};
  list.forEach(s => {
    if (!s.slot) return;
    slotMap[s.slot.toString().toUpperCase()] = s;
  });

  // ðŸ”¥ Numeric + Letter slots combineren
  const numericSlots = Array.from({ length: MAX_SLOTS }, (_, i) => (i + 1).toString());
  const letterSlots  = ["A","B","C","D","E","F","G","H","I","J","K"];

  const allSlots = [...numericSlots, ...letterSlots];

  const occupied = new Set();

  allSlots.forEach(slotKey => {

    // skip als numeric slot al bezet door uHeight stacking
    if (!isNaN(slotKey) && occupied.has(Number(slotKey))) {
      return;
    }

    const row = document.createElement("div");
    row.className = "slot-row";

    const server = slotMap[slotKey];

    if (server) {

      const isNumeric = !isNaN(slotKey);

      let uHeight = 1;

      if (isNumeric) {
        const profile = findServerProfile(server.motherboard);
        uHeight = profile?.uHeight || 1;

        // markeer onderliggende slots als bezet
        for (let u = 0; u < uHeight; u++) {
          occupied.add(Number(slotKey) + u);
        }

        row.style.gridRow = `span ${uHeight}`;
        row.style.height = `${34 * uHeight}px`;
      }

      row.innerHTML = `
        <div>${slotKey}</div>
        <div>
          <span class="status-badge ${statusClass(server.status)}">
            ${server.status}
          </span>
        </div>

        <div class="board-cell">
          <span class="hardware-icon">
            <svg class="hw-icon" viewBox="0 0 24 24">
              <rect x="3" y="5" width="18" height="4" rx="1"></rect>
              <rect x="3" y="11" width="18" height="4" rx="1"></rect>
              <rect x="3" y="17" width="18" height="2" rx="1"></rect>
            </svg>
            <div class="hardware-tooltip">
              ${buildHardwareTooltip(server)}
            </div>
          </span>
          <span class="board-name">
            ${server.motherboard || server.model || "-"}
          </span>
        </div>

        <div class="hostname">${server.hostname || "-"}</div>

        <div>
          ${
            server.hardwareUrl
              ? `<a href="${server.hardwareUrl}"
                   target="_blank"
                   class="rack-link">
                   ${server.sltag || "-"}
                 </a>`
              : (server.sltag || "-")
          }
        </div>

        <div>${server.accountId || "-"}</div>

        <div class="age-cell">
          ${formatHardwareAge(server.ageDays)}
          ${
            isOlderThanSixYears(server.ageDays)
              ? `
                <span class="age-warning-wrapper">
                  <span class="age-warning">!</span>
                  <span class="age-tooltip">
                    Warning: server is older than 6 years
                  </span>
                </span>
              `
              : ""
          }
        </div>
      `;

    } else {

      row.innerHTML = `
        <div>${slotKey}</div>
        <div></div>
        <div></div>
        <div class="empty">â€” empty â€”</div>
        <div></div>
        <div></div>
        <div></div>
      `;
    }

    container.appendChild(row);

  });
}

 /**********************************************************************************************/

function renderPowerSummary(rack, list) {

  const rackInput = list.map(s => ({
    slot: s.slot,
    serverProfile: findServerProfile(s.motherboard),
    utilization: "normal"
  }));

  const result = calculateRack(rackInput);

  const banks = result.banks;
  const phases = result.phases;
  const totalAmp = result.totalAmp;

  // ðŸ”½ NIEUW: rack analyse toevoegen
  const rackServers = list.map(s => ({
    slot: s.slot,
    uHeight: findServerProfile(s.motherboard)?.uHeight || 1
  }));

  const rackAnalysis = analyzeRack(rackServers, banks, phases);
  const rackPenalty  = calculateRackPenalty(rackAnalysis);

  console.log("Rack Analysis:", rackAnalysis);
  console.log("Rack Penalty:", rackPenalty);

    function usageClass(value, limit) {
      if (value > limit) return "bad";
      if (value > limit * 0.8) return "warn";
      return "ok";
    }

    const container = document.getElementById("powerSummary");

container.innerHTML = `
  <div class="rack-detail-header">${formatRackDisplay(rack)}</div>

  <div class="power-card ${usageClass(totalAmp, PHASE_LIMIT * 3)}">
    <div class="power-title">Total Design Load</div>
    <div class="power-value">${totalAmp.toFixed(2)} A</div>
  </div>

      <div class="power-card">
        <div class="power-title">Phase Usage</div>
        ${phases.map((p,i)=>`
          <div class="${usageClass(p, PHASE_LIMIT)}">
            L${i+1}: ${p.toFixed(2)}A / ${PHASE_LIMIT}A
          </div>
        `).join("")}
      </div>

      <div class="power-card">
        <div class="power-title">Bank Usage</div>
        ${banks.map((b,i)=>`
          <div class="${usageClass(b, BANK_LIMIT)}">
            Bank ${String.fromCharCode(65+i)}: ${b.toFixed(2)}A / ${BANK_LIMIT}A
          </div>
        `).join("")}
      </div>
    `;
  }

 /**********************************************************************************************/

function renderStatusOverview(data) {

  const container = document.getElementById("statusOverview");
  if (!container) return;

  const STATUS_ORDER = [
    "ACTIVE",
    "RESERVED",
    "PLANNED",
    "INVENTORY",
    "QUARANTINE",
    "LIQUIDATION",
    "MISSING_PARTS",
    "HARDFAIL",
    "RECLAIM",
    "DEPLOY",
    "SPARE"
  ];

  const stats = {};

  data.forEach(s => {
    const status = (s.status || "")
      .toUpperCase()
      .trim()
      .replace(/\s+/g, "_");

    if (!status) return;

    stats[status] = (stats[status] || 0) + 1;
  });

  const total = data.length;

  const sortedStatuses = Object.keys(stats)
    .sort((a, b) => {
      const aIndex = STATUS_ORDER.indexOf(a);
      const bIndex = STATUS_ORDER.indexOf(b);

      if (aIndex === -1 && bIndex === -1) return 0;
      if (aIndex === -1) return 1;
      if (bIndex === -1) return -1;

      return aIndex - bIndex;
    });

  container.innerHTML = `
    <div class="status-box total-box">
      TOTAL <span>${total}</span>
    </div>

    ${sortedStatuses.map(status => `
      <div 
        class="status-box status-${status} ${activeStatusFilters.has(status) ? "active-filter" : ""}"
        data-status="${status}"
      >
        ${status.replace(/_/g, " ")}
        <span>${stats[status]}</span>
      </div>
    `).join("")}
  `;

  document.querySelectorAll(".status-box[data-status]").forEach(el => {
    el.onclick = () => {

      const clickedStatus = el.dataset.status;

      if (activeStatusFilters.has(clickedStatus)) {
        activeStatusFilters.delete(clickedStatus);
      } else {
        activeStatusFilters.add(clickedStatus);
      }

      renderRooms();
    };
  });
}

 /**********************************************************************************************/

function populatePlacementServers() {

  const select = document.getElementById("placementServerSelect");
  if (!select) return;

  select.innerHTML = `<option value="">Select Server</option>`;

  // ðŸ”¥ GEEN sort â€” volgorde blijft exact zoals in servers.js

  SERVER_PROFILES.forEach(server => {

    const opt = document.createElement("option");
    opt.value = server.id;
    opt.textContent = `${server.id} `;

    select.appendChild(opt);
  });
}

 /**********************************************************************************************/

function populatePlacementRooms(filteredServers) {

  const select = document.getElementById("placementRoomSelect");
  if (!select) return;
  const rooms = [...new Set(
    filteredServers
      .map(s => s.room)
      .filter(room => room && !room.startsWith("STR")) // ðŸ”¥ STR uitsluiten
  )].sort((a,b) => a.localeCompare(b));

  rooms.forEach(room => {
    const opt = document.createElement("option");
    opt.value = room;
    opt.textContent = room;
    select.appendChild(opt);
  });
}
 /**********************************************************************************************/

function renderPlacementAdvisor(suggestions = []) {

  const container = document.getElementById("placementAdvisor");
  if (!container) return;

  const MAX_RESULTS = 5;

  // Maak altijd 4 slots
  const padded = Array.from({ length: MAX_RESULTS }, (_, i) => {
    return suggestions[i] || null;
  });

  container.innerHTML = `
    <div class="advisor-list">
      ${padded.map((s, index) => {

        const rankNumber = index + 1;

        const medal =
          index === 0 ? "#1" :
          index === 1 ? "#2" :
          index === 2 ? "#3" :
          index === 3 ? "#4" :
          index === 4 ? "#5" :
          "";

        // ðŸ”¹ Placeholder (geen resultaat)
        if (!s) {
          return `
            <div class="advisor-item advisor-placeholder">
              <div class="advisor-left">
                <div class="advisor-rank">${medal}</div>
                <div class="advisor-info"></div>
              </div>
              <div class="advisor-score">--</div>
            </div>
          `;
        }

        const scorePercent = Math.round(s.slotScore * 100);

        const safetyClass =
          s.slotScore < 0.7 ? "advisor-safe" :
          s.slotScore < 0.9 ? "advisor-warn" :
          "advisor-danger";

        const explanation = buildPlacementExplanation(s);

        return `
          <div class="advisor-item ${safetyClass}"
               data-rack="${s.rackId}"
               data-room="${s.room}">

            <div class="advisor-left">
              <div class="advisor-rank">${medal}</div>

              <div class="advisor-info">
                      Server Room ${s.room.replace(/\D/g,"")}   âž    
                      Rack ${s.rackId.match(/\d+/)?.[0]}   âž    Slot ${s.slot}

                <div class="advisor-reason">
                  ${explanation}
                </div>
              </div>
            </div>

            <div class="advisor-score">
              ${scorePercent}% Load
            </div>

          </div>
        `;
      }).join("")}
    </div>
  `;

  // Alleen click handlers voor echte resultaten
  document.querySelectorAll(".advisor-item:not(.advisor-placeholder)")
    .forEach(el => {

      el.onclick = () => {

        document.querySelectorAll(".advisor-item")
          .forEach(x => x.classList.remove("active-result"));

        el.classList.add("active-result");

        const rackId = el.dataset.rack;
        const room   = el.dataset.room;

        const rackCard = document.querySelector(
          `.rack-card[data-rack="${rackId}"][data-room="${room}"]`
        );

        if (!rackCard) return;

        rackCard.click();
      };
    });
}

// ================= BACK TO TOP =================

const backToTop = document.getElementById("backToTop");
const content = document.getElementById("content");

if (backToTop && content) {

  content.addEventListener("scroll", () => {
    if (content.scrollTop > 300) {
      backToTop.classList.add("visible");
    } else {
      backToTop.classList.remove("visible");
    }
  });

  backToTop.addEventListener("click", () => {
    content.scrollTo({
      top: 0,
      behavior: "smooth"
    });
  });

}
  
}

</script>
